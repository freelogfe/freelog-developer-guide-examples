<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmulatorJS startNewGame 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .game-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #game-container {
            width: 100%;
            height: 500px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #000;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
        }
        .game-info {
            margin-top: 15px;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EmulatorJS startNewGame 方法测试</h1>
        
        <div class="controls">
            <h3>游戏切换控制</h3>
            <div class="game-buttons">
                <button onclick="switchToGame('90坦克.nes', '90坦克')">切换到 90坦克</button>
                <button onclick="switchToGame('93超级魂.nes', '93超级魂')">切换到 93超级魂</button>
                <button onclick="switchToGame('https://example.com/game.nes', '网络游戏')">切换到网络游戏</button>
                <button onclick="switchToGameWithAutoStart(false)">切换但不自动启动</button>
                <button onclick="getCurrentGameInfo()">获取当前游戏信息</button>
            </div>
            
            <div class="game-info">
                <strong>当前游戏:</strong> <span id="current-game">无</span><br>
                <strong>游戏URL:</strong> <span id="current-url">无</span><br>
                <strong>模拟器状态:</strong> <span id="emulator-status">未初始化</span><br>
                <strong>手柄状态:</strong> <span id="gamepad-status">未检测</span><br>
                <strong>连接的手柄:</strong> <span id="connected-gamepads">无</span>
            </div>
        </div>

        <div id="game-container"></div>
        
        <div class="status" id="status">
            等待模拟器初始化...
        </div>
    </div>

    <script src="src/data/loader.js"></script>
    <script>
        let emulator = null;
        let currentGameConfig = null;

        // 初始化模拟器
        function initEmulator() {
            const config = {
                gameUrl: '90坦克.nes',
                gameName: '90坦克',
                system: 'nes',
                startOnLoad: true,
                volume: 0.5,
                backgroundColor: '#333'
            };

            emulator = new EmulatorJS(document.getElementById('game-container'), config);
            
            // 监听事件
            emulator.on('ready', function() {
                updateStatus('模拟器已准备就绪');
                updateEmulatorStatus('已准备');
                updateGameInfo('90坦克', '90坦克.nes');
                startGamepadMonitoring();
            });

            emulator.on('start', function() {
                updateStatus('游戏已启动');
                updateEmulatorStatus('运行中');
                updateGamepadStatus();
            });

            emulator.on('exit', function() {
                updateStatus('游戏已退出');
                updateEmulatorStatus('已退出');
                updateGamepadStatus();
            });

            currentGameConfig = config;
        }

        // 切换游戏
        function switchToGame(gameUrl, gameName) {
            if (!emulator) {
                updateStatus('错误: 模拟器未初始化');
                return;
            }

            updateStatus(`正在切换到游戏: ${gameName}`);
            
            const newConfig = {
                gameUrl: gameUrl,
                gameName: gameName,
                autoStart: true
            };

            const result = emulator.startNewGame(newConfig);
            
            if (result) {
                updateStatus(`成功启动游戏切换: ${gameName}`);
                currentGameConfig = newConfig;
                updateGameInfo(gameName, gameUrl);
            } else {
                updateStatus(`游戏切换失败: ${gameName}`);
            }
        }

        // 切换游戏但不自动启动
        function switchToGameWithAutoStart(autoStart) {
            if (!emulator) {
                updateStatus('错误: 模拟器未初始化');
                return;
            }

            const newConfig = {
                gameUrl: '93超级魂.nes',
                gameName: '93超级魂',
                autoStart: autoStart
            };

            updateStatus(`切换到 93超级魂 (自动启动: ${autoStart})`);
            
            const result = emulator.startNewGame(newConfig);
            
            if (result) {
                updateStatus(`游戏切换成功，等待手动启动`);
                currentGameConfig = newConfig;
                updateGameInfo('93超级魂', '93超级魂.nes');
            }
        }

        // 获取当前游戏信息
        function getCurrentGameInfo() {
            if (!emulator) {
                updateStatus('错误: 模拟器未初始化');
                return;
            }

            const info = {
                gameName: currentGameConfig?.gameName || '未知',
                gameUrl: currentGameConfig?.gameUrl || '未知',
                started: emulator.started,
                paused: emulator.paused,
                version: emulator.ejs_version
            };

            updateStatus(`当前游戏信息: ${JSON.stringify(info, null, 2)}`);
        }

        // 更新状态显示
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusEl.textContent = `[${timestamp}] ${message}`;
            console.log(`[EmulatorJS Test] ${message}`);
        }

        // 更新游戏信息显示
        function updateGameInfo(gameName, gameUrl) {
            document.getElementById('current-game').textContent = gameName;
            document.getElementById('current-url').textContent = gameUrl;
        }

        // 更新模拟器状态显示
        function updateEmulatorStatus(status) {
            document.getElementById('emulator-status').textContent = status;
        }

        // 开始手柄监控
        function startGamepadMonitoring() {
            updateGamepadStatus();
            
            // 定期更新手柄状态
            setInterval(updateGamepadStatus, 2000);
        }

        // 更新手柄状态显示
        function updateGamepadStatus() {
            if (!emulator || !emulator.gamepad) {
                document.getElementById('gamepad-status').textContent = '未初始化';
                document.getElementById('connected-gamepads').textContent = '无';
                return;
            }

            const gamepads = emulator.gamepad.gamepads || [];
            const connectedCount = gamepads.length;
            
            if (connectedCount > 0) {
                document.getElementById('gamepad-status').textContent = '已连接';
                const gamepadNames = gamepads.map(gp => `${gp.id} (${gp.index})`).join(', ');
                document.getElementById('connected-gamepads').textContent = gamepadNames;
            } else {
                document.getElementById('gamepad-status').textContent = '未连接';
                document.getElementById('connected-gamepads').textContent = '无';
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            updateStatus('正在加载模拟器...');
            
            // 等待脚本加载完成
            setTimeout(function() {
                if (typeof EmulatorJS !== 'undefined') {
                    initEmulator();
                } else {
                    updateStatus('错误: EmulatorJS 未加载');
                }
            }, 1000);
        });

        // 错误处理
        window.addEventListener('error', function(e) {
            updateStatus(`错误: ${e.message}`);
            console.error('EmulatorJS Test Error:', e);
        });
    </script>
</body>
</html>
