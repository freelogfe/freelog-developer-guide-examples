<!DOCTYPE html>
<html>
  <head>
    <title>EmulatorJS</title>
    <link rel="stylesheet" href="src/data/emulator.css" />
    <link rel = icon href = docs/favicon.ico sizes = "16x16 32x32 48x48 64x64"
    type = image/vnd.microsoft.icon>
    <meta name="viewport" content="width = device-width, initial-scale = 1" />
    <style>
      body,
      html {
        height: 100%;
        background-color: black;
        color: white;
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #container {
        display: flex;
        height: 100vh;
      }

      /* 左侧游戏列表 */
      #game-list {
        width: 250px;
        background-color: #222;
        padding: 20px;
        overflow-y: auto;
        border-right: 1px solid #444;
      }

      #game-list h2 {
        margin-top: 0;
        text-align: center;
        color: #fff;
      }

      .game-item {
        padding: 12px;
        margin: 8px 0;
        background-color: #333;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-align: center;
      }

      .game-item:hover {
        background-color: #444;
      }

      .game-item.active {
        background-color: #007bff;
      }

      /* 右侧模拟器区域 */
      #emulator-area {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      #game-info {
        padding: 12px 20px;
        background-color: #333;
        border-bottom: 1px solid #444;
      }

      #game-info h2 {
        margin: 0;
        color: #fff;
      }

      #emulator-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      #display {
        width: 100%;
        height: 100%;
        max-width: 800px;
        max-height: 600px;
        background-color: #111;
        border-radius: 4px;
        overflow: hidden;
      }

      #game {
        width: 100%;
        height: 100%;
      }

      #initial-screen {
        text-align: center;
        color: #aaa;
        padding: 20px;
      }

      #initial-screen .logo {
        width: 100px;
        height: 100px;
        filter: drop-shadow(0 0 10px white);
        margin-bottom: 20px;
      }

      #initial-screen p {
        font-size: 18px;
      }

      select,
      button {
        padding: 0.6em 0.4em;
        margin: 0.5em;
        width: 15em;
        max-width: 100%;
        font-family: monospace;
        font-weight: bold;
        font-size: 16px;
        background-color: #444;
        color: #aaa;
        border-radius: 0.4em;
        border: 1px solid #555;
        cursor: pointer;
        transition-duration: 0.2s;
      }

      select:hover,
      button:hover {
        background-color: #666;
        color: #ddd;
      }

      .error-message {
        color: #ff6b6b;
        font-size: 16px;
        padding: 10px;
        text-align: center;
      }

      .loading-message {
        color: #4caf50;
        font-size: 16px;
        text-align: center;
        padding: 20px;
      }

      .game-item.loading {
        background-color: #555;
        cursor: not-allowed;
        opacity: 0.7;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <!-- 左侧游戏列表 -->
      <div id="game-list">
        <h2>游戏列表</h2>
        <div class="game-item" data-rom="90坦克.nes" data-core="nes">
          90坦克
        </div>
        <div class="game-item" data-rom="93超级魂.nes" data-core="nes">
          93超级魂
        </div>
        <div class="game-item" data-rom="F-1赛车.nes" data-core="nes">
          F-1赛车
        </div>
        
        <h3 style="margin-top: 30px; margin-bottom: 10px; font-size: 16px;">测试控制</h3>
        <button id="test-switch-no-auto" style="width: 100%; margin: 5px 0; padding: 8px; font-size: 12px;">
          切换但不自动启动
        </button>
        <button id="test-get-info" style="width: 100%; margin: 5px 0; padding: 8px; font-size: 12px;">
          获取当前信息
        </button>
        <button id="test-clear-console" style="width: 100%; margin: 5px 0; padding: 8px; font-size: 12px;">
          清空控制台
        </button>
      </div>

      <!-- 右侧模拟器区域 -->
      <div id="emulator-area">
        <div id="game-info">
          <h2>请选择一个游戏</h2>
          <div id="status-info" style="font-size: 12px; color: #aaa; margin-top: 5px;">
            状态: 未初始化 | 手柄: 未检测
          </div>
        </div>
        <div id="emulator-container">
          <div id="display">
            <div id="game">
              <div id="initial-screen">
                <img src="docs/Logo-light.png" alt="Logo" class="logo" />
                <p>请选择左侧游戏列表中的游戏开始游玩</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 加载 EmulatorManager -->
    <!-- <script src="dist/esm/index.js" type="module"></script> -->
    <script type="module">
      import { runGame } from "./src/index.js";

      let enableDebug = false;
      let enableThreads = false;
      let currentGame = null;
      let emulatorReady = false;

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);

      if (
        parseInt(urlParams.get("debug")) === 1 ||
        urlParams.get("debug") === "true"
      ) {
        enableDebug = true;
        console.log("Debug is enabled");
      } else {
        console.log("Debug is disabled");
      }

      if (
        parseInt(urlParams.get("threads")) === 1 ||
        urlParams.get("threads") === "true"
      ) {
        if (window.SharedArrayBuffer) {
          enableThreads = true;
          console.log("Threads are enabled");
        } else {
          console.warn(
            "Threads are disabled as SharedArrayBuffer is not available. Threads requires two headers to be set when sending you html page. See https://stackoverflow.com/a/68630724"
          );
          console.log("Threads are disabled");
        }
      } else {
        console.log("Threads are disabled");
      }
      let controller = null;
      
      // 状态更新函数
      function updateStatus(emulatorStatus, gamepadStatus) {
        const statusInfo = document.getElementById("status-info");
        if (statusInfo) {
          statusInfo.textContent = `状态: ${emulatorStatus} | 手柄: ${gamepadStatus}`;
        }
      }

      // 手柄状态监控
      function startGamepadMonitoring() {
        setInterval(() => {
          if (controller && controller.gamepad) {
            const gamepads = controller.gamepad.gamepads || [];
            const connectedCount = gamepads.length;
            const gamepadStatus = connectedCount > 0 ? `已连接 (${connectedCount})` : '未检测';
            const emulatorStatus = controller.started ? '运行中' : '已停止';
            updateStatus(emulatorStatus, gamepadStatus);
          } else {
            updateStatus('未初始化', '未检测');
          }
        }, 2000);
      }

      // 为游戏列表项添加点击事件
      document.querySelectorAll(".game-item").forEach((item) => {
        item.addEventListener("click", async () => {
          // 如果正在加载，避免重复点击
          if (item.classList.contains("loading")) {
            return;
          }

          // 更新激活状态
          document
            .querySelectorAll(".game-item")
            .forEach((i) => i.classList.remove("active"));
          item.classList.add("active");

          // 获取游戏信息
          const rom = item.getAttribute("data-rom");
          const name = item.textContent.trim();
          const core = item.getAttribute("data-core");

          // 添加加载状态
          item.classList.add("loading");
          updateStatus('切换游戏中...', '检测中');

          try {
            // 加载游戏
            if (controller) {
              console.log(`切换到游戏: ${name} (${rom})`);
              const success = controller.startNewGame({ gameUrl: rom, gameName: name });
              if (success) {
                console.log(`成功启动游戏切换: ${name}`);
                updateStatus('游戏已切换', '检测中');
              } else {
                console.error(`游戏切换失败: ${name}`);
                updateStatus('切换失败', '未检测');
              }
            } else {
              console.log(`首次加载游戏: ${name} (${rom})`);
              updateStatus('首次加载...', '检测中');
              controller = await loadGame({
                rom: rom,
                name: name,
                core: core,
              });
            }
          } catch (error) {
            console.error("Failed to load game:", error);
            showError("Failed to load game: " + error.message);
            updateStatus('加载失败', '未检测');
          } finally {
            // 移除加载状态
            item.classList.remove("loading");
          }
        });
      });

      // 加载游戏函数
      async function loadGame(game) {
        // 更新当前游戏信息
        currentGame = game;

        // 更新游戏信息显示
        document.querySelector("#game-info h2").textContent = game.name;

        // 显示加载状态
        const gameElement = document.getElementById("game");
        const initialScreen = document.getElementById("initial-screen");
        if (initialScreen) {
          initialScreen.remove();
        }
        gameElement.innerHTML =
          '<div class="loading-message">正在加载游戏...</div>';

        // 使用 EmulatorManager 运行游戏
        const emulator = await runGame({
          gameUrl: game.rom,
          container: "#game",
          gameName: game.name,
          core: game.core,
          pathtodata: "./src/data",
          corePath:
            "https://cdn.jsdelivr.net/gh/EmulatorJS/EmulatorJS@latest/data/cores/",
          debug: enableDebug,
          threads: enableThreads,
          onGameStart: function () {
            // 游戏成功启动后，清除加载消息
            const loadingMessage = document.querySelector(".loading-message");
            if (loadingMessage) {
              loadingMessage.remove();
            }
            updateStatus('游戏已启动', '检测中');
            console.log(`游戏 ${game.name} 启动成功`);
          },
        });

        // 监听模拟器事件
        if (emulator) {
          emulator.on('ready', function() {
            console.log('模拟器已准备就绪');
            updateStatus('已准备', '检测中');
          });

          emulator.on('start', function() {
            console.log('游戏已启动');
            updateStatus('运行中', '检测中');
          });

          emulator.on('exit', function() {
            console.log('游戏已退出');
            updateStatus('已退出', '检测中');
          });

          // 启动手柄监控
          startGamepadMonitoring();
        }

        return emulator;
      }

      // 测试按钮事件处理
      document.addEventListener("DOMContentLoaded", () => {
        // 确保初始屏幕存在
        const gameElement = document.getElementById("game");
        const initialScreen = document.getElementById("initial-screen");

        if (gameElement && !initialScreen) {
          const initialScreenHTML = `
                              <div id="initial-screen">
                                  <img src="docs/Logo-light.png" alt="Logo" class="logo">
                                  <p>请选择左侧游戏列表中的游戏开始游玩</p>
                              </div>
                          `;
          gameElement.innerHTML = initialScreenHTML;
        }

        // 切换但不自动启动按钮
        document.getElementById('test-switch-no-auto').addEventListener('click', () => {
          if (!controller) {
            console.log('请先选择一个游戏启动模拟器');
            return;
          }

          // 获取当前游戏之外的游戏
          const activeItem = document.querySelector('.game-item.active');
          if (!activeItem) return;

          const allGames = Array.from(document.querySelectorAll('.game-item'));
          const otherGames = allGames.filter(item => !item.classList.contains('active'));
          
          if (otherGames.length === 0) {
            console.log('没有其他游戏可以切换');
            return;
          }

          // 随机选择一个其他游戏
          const randomGame = otherGames[Math.floor(Math.random() * otherGames.length)];
          const rom = randomGame.getAttribute('data-rom');
          const name = randomGame.textContent.trim();

          console.log(`测试切换到游戏: ${name} (不自动启动)`);
          updateStatus('测试切换中...', '检测中');

          try {
            const success = controller.startNewGame({ 
              gameUrl: rom, 
              gameName: name,
              autoStart: false
            });
            
            if (success) {
              console.log(`成功切换到: ${name}，等待手动启动`);
              updateStatus('已切换，等待启动', '检测中');
              
              // 更新激活状态
              document.querySelectorAll('.game-item').forEach(i => i.classList.remove('active'));
              randomGame.classList.add('active');
              document.querySelector("#game-info h2").textContent = name + ' (等待启动)';
            } else {
              console.error(`切换失败: ${name}`);
              updateStatus('切换失败', '未检测');
            }
          } catch (error) {
            console.error('切换测试失败:', error);
            updateStatus('测试失败', '未检测');
          }
        });

        // 获取当前信息按钮
        document.getElementById('test-get-info').addEventListener('click', () => {
          if (!controller) {
            console.log('模拟器未初始化');
            return;
          }

          const info = {
            currentGame: currentGame ? currentGame.name : '未知',
            gameUrl: currentGame ? currentGame.rom : '未知',
            started: controller.started,
            paused: controller.paused,
            version: controller.ejs_version || '未知',
            gamepadConnected: controller.gamepad && controller.gamepad.gamepads ? controller.gamepad.gamepads.length : 0,
            hasTextElement: !!controller.textElem,
            hasModule: !!controller.Module,
            hasGameManager: !!controller.gameManager
          };

          console.log('=== 当前模拟器信息 ===');
          console.log('当前游戏:', info.currentGame);
          console.log('游戏URL:', info.gameUrl);
          console.log('运行状态:', info.started ? '运行中' : '已停止');
          console.log('暂停状态:', info.paused ? '已暂停' : '正常运行');
          console.log('版本:', info.version);
          console.log('连接手柄数:', info.gamepadConnected);
          console.log('文本元素:', info.hasTextElement ? '存在' : '不存在');
          console.log('模块:', info.hasModule ? '存在' : '不存在');
          console.log('游戏管理器:', info.hasGameManager ? '存在' : '不存在');
          console.log('========================');
          
          updateStatus(info.started ? '运行中' : '已停止', `${info.gamepadConnected} 个手柄`);
        });

        // 清空控制台按钮
        document.getElementById('test-clear-console').addEventListener('click', () => {
          console.clear();
          console.log('控制台已清空 - EmulatorJS startNewGame 测试');
        });
      });

      function showError(message) {
        const display = document.getElementById("display");
        if (display) {
          display.innerHTML = `<div class="error-message">${message}</div>`;

          // 添加重试按钮
          const retryButton = document.createElement("button");
          retryButton.textContent = "Try Again";
          retryButton.onclick = () => {
            if (currentGame) {
              // 重新添加初始屏幕
              const gameElement = document.getElementById("game");
              gameElement.innerHTML = `
                                      <div id="initial-screen">
                                          <img src="docs/Logo-light.png" alt="Logo" class="logo">
                                          <p>请选择左侧游戏列表中的游戏开始游玩</p>
                                      </div>
                                  `;
              // 重新激活当前选中项
              document.querySelectorAll(".game-item").forEach((item) => {
                if (item.textContent.trim() === currentGame.name) {
                  item.classList.add("active");
                }
              });
            }
          };
          display.appendChild(retryButton);
        }
      }
    </script>
  </body>
</html>
