<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EmulatorJS</title>
    <link rel="stylesheet" href="src/data/emulator.css">
    <link rel = icon href = docs/favicon.ico sizes = "16x16 32x32 48x48 64x64"
    type = image/vnd.microsoft.icon>
    <meta name="viewport" content="width = device-width, initial-scale = 1" />
    <style>
      body,
      html {
        height: 100%;
        background-color: black;
        color: white;
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #container {
        display: flex;
        height: 100vh;
      }

      /* 左侧游戏列表 */
      #game-list {
        width: 250px;
        background-color: #222;
        padding: 20px;
        overflow-y: auto;
        border-right: 1px solid #444;
      }

      #game-list h2 {
        margin-top: 0;
        text-align: center;
        color: #fff;
      }

      .game-item {
        padding: 12px;
        margin: 8px 0;
        background-color: #333;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-align: center;
      }

      .game-item:hover {
        background-color: #444;
      }

      .game-item.active {
        background-color: #007bff;
      }

      .game-item.loading::after {
        content: "...";
        animation: loading 1s infinite;
      }

      @keyframes loading {
        0% {
          content: ".";
        }
        33% {
          content: "..";
        }
        66% {
          content: "...";
        }
      }

      /* 右侧游戏显示区域 */
      #emulator-area {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      #game-info {
        padding: 15px;
        background-color: #333;
        border-bottom: 1px solid #444;
      }

      #game-info h2 {
        margin: 0;
        font-size: 1.5em;
      }

      #emulator-container {
        flex: 1;
        position: relative;
        background-color: #000;
      }

      #display {
        height: 100%;
        position: relative;
      }

      #game {
        height: 100%;
        position: relative;
      }

      #game > div {
        height: 100%;
      }

      .loading-message {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #ccc;
        font-size: 1.2em;
      }

      .error-message {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #ff6b6b;
        font-size: 1.2em;
        flex-direction: column;
      }

      #initial-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        text-align: center;
      }

      #initial-screen .logo {
        max-width: 200px;
        margin-bottom: 20px;
      }

      #initial-screen p {
        color: #ccc;
        font-size: 1.2em;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <!-- 左侧游戏列表 -->
      <div id="game-list">
        <h2>游戏列表</h2>
        <div class="game-item" data-rom="90坦克.nes" data-core="nes">
          90坦克
        </div>
        <div class="game-item" data-rom="93超级魂.nes" data-core="nes">
          93超级魂
        </div>
        <div class="game-item" data-rom="F-1赛车.nes" data-core="nes">
          F-1赛车
        </div>
      </div>

      <!-- 右侧模拟器区域 -->
      <div id="emulator-area">
        <div id="game-info">
          <h2>请选择一个游戏</h2>
        </div>
        <div id="emulator-container">
          <div id="display">
            <div id="game">
              <div id="initial-screen">
                <img src="docs/Logo-light.png" alt="Logo" class="logo" />
                <p>请选择左侧游戏列表中的游戏开始游玩</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 加载 EmulatorJS -->
    <script type="module">
      import { runGame } from "./src/index.js";

      let enableDebug = false;
      let enableThreads = false;
      let currentGame = null;
      let emulatorReady = false;

      // 为游戏列表项添加点击事件
      document.querySelectorAll(".game-item").forEach((item) => {
        item.addEventListener("click", async () => {
          // 如果正在加载，避免重复点击
          if (item.classList.contains("loading")) {
            return;
          }

          // 更新激活状态
          document
            .querySelectorAll(".game-item")
            .forEach((i) => i.classList.remove("active"));
          item.classList.add("active");

          // 获取游戏信息
          const rom = item.getAttribute("data-rom");
          const name = item.textContent.trim();
          const core = item.getAttribute("data-core");

          // 添加加载状态
          item.classList.add("loading");

          try {
            // 更新游戏信息显示
            document.querySelector("#game-info h2").textContent = name;

            // 显示加载状态
            const gameElement = document.getElementById("game");
            const initialScreen = document.getElementById("initial-screen");
            if (initialScreen) {
              initialScreen.remove();
            }
            gameElement.innerHTML =
              '<div class="loading-message">正在加载游戏...</div>';

            // 使用 EmulatorManager 运行游戏
            const emulator = await runGame({
              gameUrl: rom,
              gameName: name,
              core: core,
              debug: enableDebug,
              pathtodata: "./src/data",
              threads: enableThreads,
            });

            // 成功加载后确保保留Emulator容器
            // 保持gameElement内的内容不变，因为EmulatorJS需要容器元素
            console.log("Game loaded successfully");
          } catch (error) {
            console.error("Failed to load game:", error);
            showError("Failed to load game: " + error.message);
            throw error;
          } finally {
            // 移除加载状态
            item.classList.remove("loading");
          }
        });
      });

      function showError(message) {
        const display = document.getElementById("display");
        if (display) {
          display.innerHTML = `<div class="error-message">${message}</div>`;

          // 添加重试按钮
          const retryButton = document.createElement("button");
          retryButton.textContent = "Try Again";
          retryButton.onclick = () => {
            if (currentGame) {
              // 重新添加初始屏幕
              const gameElement = document.getElementById("game");
              gameElement.innerHTML = `
                                <div id="initial-screen">
                                    <img src="docs/Logo-light.png" alt="Logo" class="logo">
                                    <p>请选择左侧游戏列表中的游戏开始游玩</p>
                                </div>
                            `;
              // 重新激活当前选中项
              document.querySelectorAll(".game-item").forEach((item) => {
                if (item.textContent.trim() === currentGame.name) {
                  item.classList.add("active");
                }
              });
            }
          };
          display.appendChild(retryButton);
        }
      }
    </script>
  </body>
</html>
