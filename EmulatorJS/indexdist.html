<!DOCTYPE html>
<html>
  <head>
    <title>EmulatorJS</title>
    <link rel="stylesheet" href="dist/esm/data/emulator.css" />
    <link rel = icon href = docs/favicon.ico sizes = "16x16 32x32 48x48 64x64"
    type = image/vnd.microsoft.icon>
    <meta name="viewport" content="width = device-width, initial-scale = 1" />
    <style>
      body,
      html {
        height: 100%;
        background-color: black;
        color: white;
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #container {
        display: flex;
        height: 100vh;
      }

      /* 左侧游戏列表 */
      #game-list {
        width: 250px;
        background-color: #222;
        padding: 20px;
        overflow-y: auto;
        border-right: 1px solid #444;
      }

      #game-list h2 {
        margin-top: 0;
        text-align: center;
        color: #fff;
      }

      .game-item {
        padding: 12px;
        margin: 8px 0;
        background-color: #333;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-align: center;
      }

      .game-item:hover {
        background-color: #444;
      }

      .game-item.active {
        background-color: #007bff;
      }

      /* 右侧模拟器区域 */
      #emulator-area {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      #game-info {
        padding: 12px 20px;
        background-color: #333;
        border-bottom: 1px solid #444;
      }

      #game-info h2 {
        margin: 0;
        color: #fff;
      }

      #emulator-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      #display {
        width: 100%;
        height: 100%;
        max-width: 800px;
        max-height: 600px;
        background-color: #111;
        border-radius: 4px;
        overflow: hidden;
      }

      #game {
        width: 100%;
        height: 100%;
      }

      #initial-screen {
        text-align: center;
        color: #aaa;
        padding: 20px;
      }

      #initial-screen .logo {
        width: 100px;
        height: 100px;
        filter: drop-shadow(0 0 10px white);
        margin-bottom: 20px;
      }

      #initial-screen p {
        font-size: 18px;
      }

      select,
      button {
        padding: 0.6em 0.4em;
        margin: 0.5em;
        width: 15em;
        max-width: 100%;
        font-family: monospace;
        font-weight: bold;
        font-size: 16px;
        background-color: #444;
        color: #aaa;
        border-radius: 0.4em;
        border: 1px solid #555;
        cursor: pointer;
        transition-duration: 0.2s;
      }

      select:hover,
      button:hover {
        background-color: #666;
        color: #ddd;
      }

      .error-message {
        color: #ff6b6b;
        font-size: 16px;
        padding: 10px;
        text-align: center;
      }

      .loading-message {
        color: #4caf50;
        font-size: 16px;
        text-align: center;
        padding: 20px;
      }

      .game-item.loading {
        background-color: #555;
        cursor: not-allowed;
        opacity: 0.7;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <!-- 左侧游戏列表 -->
      <div id="game-list">
        <h2>游戏列表</h2>
        <div class="game-item" data-rom="90坦克.nes" data-core="nes">
          90坦克
        </div>
        <div class="game-item" data-rom="93超级魂.nes" data-core="nes">
          93超级魂
        </div>
        <div class="game-item" data-rom="F-1赛车.nes" data-core="nes">
          F-1赛车
        </div>
      </div>

      <!-- 右侧模拟器区域 -->
      <div id="emulator-area">
        <div id="game-info">
          <h2>请选择一个游戏</h2>
        </div>
        <div id="emulator-container">
          <div id="display">
            <div id="game">
              <div id="initial-screen">
                <img src="docs/Logo-light.png" alt="Logo" class="logo" />
                <p>请选择左侧游戏列表中的游戏开始游玩</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 加载 EmulatorManager -->
    <script src="dist/esm/index.js" type="module"></script>
    <script type="module">
      import { runGame } from "./src/index.js";

      let enableDebug = false;
      let enableThreads = false;
      let currentGame = null;
      let emulatorReady = false;

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);

      if (
        parseInt(urlParams.get("debug")) === 1 ||
        urlParams.get("debug") === "true"
      ) {
        enableDebug = true;
        console.log("Debug is enabled");
      } else {
        console.log("Debug is disabled");
      }

      if (
        parseInt(urlParams.get("threads")) === 1 ||
        urlParams.get("threads") === "true"
      ) {
        if (window.SharedArrayBuffer) {
          enableThreads = true;
          console.log("Threads are enabled");
        } else {
          console.warn(
            "Threads are disabled as SharedArrayBuffer is not available. Threads requires two headers to be set when sending you html page. See https://stackoverflow.com/a/68630724"
          );
          console.log("Threads are disabled");
        }
      } else {
        console.log("Threads are disabled");
      }

      // 为游戏列表项添加点击事件
      document.querySelectorAll(".game-item").forEach((item) => {
        item.addEventListener("click", async () => {
          // 如果正在加载，避免重复点击
          if (item.classList.contains("loading")) {
            return;
          }

          // 更新激活状态
          document
            .querySelectorAll(".game-item")
            .forEach((i) => i.classList.remove("active"));
          item.classList.add("active");

          // 获取游戏信息
          const rom = item.getAttribute("data-rom");
          const name = item.textContent.trim();
          const core = item.getAttribute("data-core");

          // 添加加载状态
          item.classList.add("loading");

          try {
            // 加载游戏
            await loadGame({
              rom: rom,
              name: name,
              core: core,
            });
          } catch (error) {
            console.error("Failed to load game:", error);
            showError("Failed to load game: " + error.message);
          } finally {
            // 移除加载状态
            item.classList.remove("loading");
          }
        });
      });

      // 加载游戏函数
      async function loadGame(game) {
        try {
          // 更新当前游戏信息
          currentGame = game;

          // 更新游戏信息显示
          document.querySelector("#game-info h2").textContent = game.name;

          // 显示加载状态
          const gameElement = document.getElementById("game");
          const initialScreen = document.getElementById("initial-screen");
          if (initialScreen) {
            initialScreen.remove();
          }
          gameElement.innerHTML = 
            '<div class="loading-message">正在加载游戏...</div>';

          // 使用 EmulatorManager 运行游戏
          const emulator = await runGame({
            gameUrl: game.rom,
            gameName: game.name,
            core: game.core,
            pathtodata: "./src/data",
            debug: enableDebug,
            threads: enableThreads,
            onGameStart: function() {
              // 游戏成功启动后，清除加载消息
              const loadingMessage = document.querySelector('.loading-message');
              if (loadingMessage) {
                loadingMessage.remove();
              }
            }
          });

          // 成功加载后确保保留Emulator容器
          // 保持gameElement内的内容不变，因为EmulatorJS需要容器元素
          console.log("Game loaded successfully");
        } catch (error) {
          console.error("Failed to load game:", error);
          showError("Failed to load game: " + error.message);
          throw error;
        } finally {
          // 始终确保有一个干净的游戏容器
          // 这里不清理innerHTML，因为EmulatorJS需要保持容器
        }
      }

      // 在页面加载时确保初始屏幕存在
      document.addEventListener("DOMContentLoaded", () => {
        // 确保初始屏幕存在
        const gameElement = document.getElementById("game");
        const initialScreen = document.getElementById("initial-screen");

        if (gameElement && !initialScreen) {
          const initialScreenHTML = `
                        <div id="initial-screen">
                            <img src="docs/Logo-light.png" alt="Logo" class="logo">
                            <p>请选择左侧游戏列表中的游戏开始游玩</p>
                        </div>
                    `;
          gameElement.innerHTML = initialScreenHTML;
        }
      });

      function showError(message) {
        const display = document.getElementById("display");
        if (display) {
          display.innerHTML = `<div class="error-message">${message}</div>`;

          // 添加重试按钮
          const retryButton = document.createElement("button");
          retryButton.textContent = "Try Again";
          retryButton.onclick = () => {
            if (currentGame) {
              // 重新添加初始屏幕
              const gameElement = document.getElementById("game");
              gameElement.innerHTML = `
                                <div id="initial-screen">
                                    <img src="docs/Logo-light.png" alt="Logo" class="logo">
                                    <p>请选择左侧游戏列表中的游戏开始游玩</p>
                                </div>
                            `;
              // 重新激活当前选中项
              document.querySelectorAll(".game-item").forEach((item) => {
                if (item.textContent.trim() === currentGame.name) {
                  item.classList.add("active");
                }
              });
            }
          };
          display.appendChild(retryButton);
        }
      }
    </script>
  </body>
</html>
