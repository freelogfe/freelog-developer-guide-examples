<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>EmulatorJS - 连发连跳</title>
    <style>
        #game { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="game"></div>

    <script>
        EJS_player = "#game";
        EJS_core = "fceumm";
        EJS_pathtodata = "https://cdn.emulatorjs.org/stable/data/";
        EJS_gameUrl = "http://localhost:5173/hun.nes";

        const TURBO_INTERVAL = 150;
        let turboState = { X: false, Y: false };
        let turboTimer = null;

        // ✅ 等待 EJS.input.js 初始化
        function waitForEJSInput() {
            if (typeof EJS_setKey !== 'undefined' && typeof EJS_keys !== 'undefined') {
                console.log('✅ EJS 输入系统已就绪');
                startGamepadPolling();
                return;
            }
            setTimeout(waitForEJSInput, 5000);
        }

        function startGamepadPolling() {
            function poll() {
                const gamepads = navigator.getGamepads?.();
                const gamepad = gamepads?.[0];
                if (!gamepad) return;

                // BUTTON_2 = X, BUTTON_3 = Y
                turboState.X = gamepad.buttons[2]?.pressed;
                turboState.Y = gamepad.buttons[3]?.pressed;

                requestAnimationFrame(poll);
            }
            poll();

            // 🔁 启动连发循环
            startTurboLoop();
        }

        function startTurboLoop() {
            // 假设 X 键映射到 'z' (A), Y 键映射到 'x' (B)
            const keyA = 'z';
            const keyB = 'x';

            turboTimer = setInterval(() => {
                if (turboState.X && EJS_keys[keyA] !== true) {
                    EJS_setKey(keyA, true);
                    // 短暂延迟后释放，模拟点击
                    setTimeout(() => EJS_setKey(keyA, false), 50);
                }
                if (turboState.Y && EJS_keys[keyB] !== true) {
                    EJS_setKey(keyB, true);
                    setTimeout(() => EJS_setKey(keyB, false), 50);
                }
            }, TURBO_INTERVAL);
        }

        // 🚀 加载 EmulatorJS
        const script = document.createElement('script');
        script.src = "https://cdn.emulatorjs.org/stable/data/loader.js";
        document.head.appendChild(script);

        // 开始等待
        setTimeout(waitForEJSInput, 5000);
    </script>
</body>
</html>